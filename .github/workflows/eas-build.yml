name: EAS Build

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      platform:
        description: 'Platform to build'
        required: true
        default: 'all'
        type: choice
        options:
          - ios
          - android
          - all
      profile:
        description: 'Build profile'
        required: true
        default: 'preview'
        type: choice
        options:
          - development
          - preview
          - production

env:
  EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

concurrency:
  group: eas-build-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Determine what to build
  setup:
    name: Setup Build Matrix
    runs-on: ubuntu-latest
    if: github.repository == 'phetzel/rn-ps'
    outputs:
      platforms: ${{ steps.set-platforms.outputs.platforms }}
      profile: ${{ steps.set-profile.outputs.profile }}
    steps:
      - name: Set platforms
        id: set-platforms
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            PLATFORM="${{ github.event.inputs.platform }}"
          else
            # TODO: Add "android" back when credentials are configured
            PLATFORM="ios"
          fi

          if [ "$PLATFORM" == "all" ]; then
            echo 'platforms=["ios", "android"]' >> $GITHUB_OUTPUT
          else
            echo "platforms=[\"$PLATFORM\"]" >> $GITHUB_OUTPUT
          fi

      - name: Set profile
        id: set-profile
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "profile=${{ github.event.inputs.profile }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == refs/heads/release/* ]]; then
            echo "profile=preview" >> $GITHUB_OUTPUT
          else
            echo "profile=preview" >> $GITHUB_OUTPUT
          fi

  # Build for each platform
  build:
    name: Build ${{ matrix.platform }}
    needs: setup
    runs-on: ubuntu-latest
    timeout-minutes: 60
    strategy:
      fail-fast: false
      matrix:
        platform: ${{ fromJson(needs.setup.outputs.platforms) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Build ${{ matrix.platform }} (${{ needs.setup.outputs.profile }})
        run: |
          eas build \
            --platform ${{ matrix.platform }} \
            --profile ${{ needs.setup.outputs.profile }} \
            --non-interactive \
            --message "Build from ${{ github.ref_name }} - ${{ github.sha }}"

      - name: Get build URL
        id: build-url
        run: |
          BUILD_INFO=$(eas build:list --platform ${{ matrix.platform }} --limit 1 --json --non-interactive)
          BUILD_URL=$(echo $BUILD_INFO | jq -r '.[0].artifacts.buildUrl // "N/A"')
          BUILD_ID=$(echo $BUILD_INFO | jq -r '.[0].id')
          echo "url=$BUILD_URL" >> $GITHUB_OUTPUT
          echo "id=$BUILD_ID" >> $GITHUB_OUTPUT
          echo "### ðŸ“± ${{ matrix.platform }} Build" >> $GITHUB_STEP_SUMMARY
          echo "- **Profile:** ${{ needs.setup.outputs.profile }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Build ID:** $BUILD_ID" >> $GITHUB_STEP_SUMMARY
          echo "- **Download:** [Build Artifact]($BUILD_URL)" >> $GITHUB_STEP_SUMMARY

  # Notify on completion
  notify:
    name: Notify Build Complete
    needs: [setup, build]
    runs-on: ubuntu-latest
    if: github.repository == 'phetzel/rn-ps' && always()
    steps:
      - name: Build Summary
        run: |
          echo "## ðŸ—ï¸ EAS Build Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Profile:** ${{ needs.setup.outputs.profile }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "View builds at: https://expo.dev/" >> $GITHUB_STEP_SUMMARY
